{"status":{},"contains_secrets":false,"product_version":"3.5.0","spec":{"description":"this runbook is intended to be called by other apps or x-play to get approval on task to make a follow up decision whether to proceed or not","resources":{"endpoints_information":[],"endpoint_definition_list":[],"client_attrs":{},"credential_definition_list":[{"username":"kazi.ahmed@gso.lab","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"pcAdm","cred_class":"static"}],"runbook":{"task_definition_list":[{"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[{"kind":"app_task","name":"Request Approval"},{"kind":"app_task","name":"Create In"}],"name":"0424da6d_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[{"kind":"app_task","name":"eab85ed8_1_META"}],"name":"Request Approval","attrs":{"loop_variable":"iteration","exit_condition_type":"dont_care","type":"","iterations":"@@{waitUntilMinutes}@@"},"timeout_secs":"0","type":"WHILE_LOOP","variable_list":[]},{"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[{"kind":"app_task","name":"Request Approval_1"},{"kind":"app_task","name":"Let Update"}],"name":"eab85ed8_1_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"Request Approval_1","attrs":{"exit_status":[],"script":"print \"Waiting {0} minutes, requesting approval for {1}\".format(@@{iteration}@@+1,\"@@{issue_name}@@\")\n## If integrating with Jira, call jira code here to check the status of an incident or ticket and\n## set the approved variable either true or false\nsleep(1*60)\napproved=True\nprint \"approved = {}\".format(approved)","eval_variables":["approved"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"Let Update","attrs":{"script":"triggerUrl=\"https:\/\/@@{pcHost}@@:@@{pcPort}@@\/api\/nutanix\/v3\/action_rules\/trigger\"\nheadersData = {'Content-Type': 'application\/json'}\ndef update_vm(url,vmName,vmUuid):\n    svcAcctPasswd = \"@@{pcAdm.secret}@@\"\n    svcAcctUserName = \"@@{pcAdm.username}@@\"\n    decision=\"0\"\n    approved = @@{approved}@@\n    if approved == True:\n      decision = \"1\"\n      \n    payLoad = {\n      \"trigger_type\": \"incoming_webhook_trigger\",\n      \"trigger_instance_list\": [{\n      \"webhook_id\": \"@@{webhookId}@@\",\n      \"string1\": \"JIRA ticket- vm upgrade\",\n      \"integer1\": decision,\n      \"entity1\": \"{\\\"type\\\":\\\"vm\\\",\\\"name\\\":\\\"\"+vmName+\"\\\",\\\"uuid\\\":\\\"\"+vmUuid+\"\\\"}\"\n      }]\n    }\n    try:\n        # print(setPowerStateUrl)\n        response = urlreq(url,\n                           user=svcAcctUserName,\n                           passwd=svcAcctPasswd,\n                           auth='BASIC',\n                           verb=\"POST\",\n                           headers=headersData,\n                           params=json.dumps(payLoad),\n                           verify=False)\n        if response.ok:\n          return True\n        else:\n          return False\n\n    except Exception as e:\n        print(e)\n        return False\n      \n  \nrepairVMUuid = \"@@{vm_uuid}@@\"\nrepairVMName = \"@@{vm_name}@@\"\n#var=\"{\\\"type\\\":\\\"vm\\\",\\\"name\\\":\\\"\"+repairVMName+\"\\\",\\\"uuid\\\":\\\"\"+repairVMUuid+\"\\\"}\"\n#print json.dumps(var)\nopsResult = update_vm(triggerUrl,repairVMName,repairVMUuid)\nif opsResult == True:\n  print \"Successfully triggerd update vm\"\nelse:\n  print \"Triggering update vm failed\"","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"Create In","attrs":{"script":"## create an incident on a jira ticket to request upgrade on the VM\n## or write custom logic to notify the approver on the request where could be read back in the successive tasks\nprint \"Received request to upgrade vm {0} with uuid {1}. Going to notify approver\".format(\"@@{vm_name}@@\",\"@@{vm_uuid}@@\")","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"33bc3a2e_runbook","main_task_local_reference":{"kind":"app_task","name":"0424da6d_dag"},"variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"webhookId","value":"95d97115-a40c-4734-7e36-587a58f20900","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"waitUntilMinutes","value":"1","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"vm_uuid","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"vm_name","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"regex":{"should_validate":false,"value":"^[\\d]*$"},"val_type":"INT","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"pcPort","value":"9440","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"pcHost","value":"10.48.108.12","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"issue_name","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]}},"name":"get_Approval"},"api_version":"3.0","metadata":{"last_update_time":"1654880496041397","kind":"runbook","spec_version":54,"creation_time":"1654210007343663","name":"get_Approval"}}